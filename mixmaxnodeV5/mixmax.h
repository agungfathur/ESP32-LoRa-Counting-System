#include "SPI.h"
#include "LoRa.h"
#include "WiFi.h"
#include "EEPROM.h"

//SERIAL CONFIG
const uint32_t DBG_baud = 115200;

//LORA CONFIG
const uint8_t  LORA_sck    = 5;
const uint8_t  LORA_miso   = 19;
const uint8_t  LORA_mosi   = 27;
const uint8_t  LORA_cs     = 18;
const uint8_t  LORA_rst    = 23;
const uint8_t  LORA_irq    = 26;
const uint32_t LORA_spif   = 10E6;
const uint32_t LORA_frq_rx = 923E6;
const uint32_t LORA_frq_tx = 921E6;
const uint8_t  LORA_sf     = 10;
const uint32_t LORA_bw     = 125E3;
const uint8_t  LORA_cr     = 6;
const uint8_t  LORA_pwr    = 17;
const uint8_t  LORA_ocp    = 240;

enum {
  _pkg_header = 0, _pkg_col = 2, _pkg_node = 4,
  _pkg_cmd = 4,
  _pkg_lat = 6, _pkg_lon = 10,
  _pkg_crc = 14
};

//GPS CONFIG
#define        GPS      Serial2
const uint32_t GPS_baud = 230400;
const uint8_t  GPS_tx   = 21;
const uint8_t  GPS_rx   = 13;
const uint8_t  GPS_pps  = 12;

//PIN CONFIG
const uint8_t  PIN_batt = 25;
const uint8_t  PIN_led  = 2;

//EEPROM CONFIG
const uint8_t  EEPROM_size = 16;
const uint8_t  EEPROM_id_node_addr    = 0;
const uint8_t  EEPROM_id_colony_addr  = 2;
const uint8_t  EEPROM_total_node_addr = 4;

typedef enum {NORMAL_mode, GPS_mode, WIFI_mode, BLE_mode} sys_mode_t;
typedef enum {GPS_none, GPS_cfg, GPS_ok} gps_status_t;
typedef enum {WIFI_none, WIFI_fail, WIFI_ok} wifi_status_t;
typedef enum {UBX_none, UBX_posllh, UBX_status, UBX_timeutc, UBX_sol} ubx_msg_t;
typedef enum {GPS_chg_mode, GPS_interrupt = 0x02, GPS_timer = 0x04} gps_wake_cause_t;

typedef struct {
  bool rx_pkg_, crc_, header_, col_, node_, ping_, cmd_, wait_, resp_, gps_fix_, gps_valid_, wifi_resp_;
} flag_t;

flag_t flag;
flag_t flag_prev;

gps_status_t  GPS_status;
wifi_status_t WIFI_status;
ubx_msg_t     UBX_msg;
RTC_DATA_ATTR gps_wake_cause_t GPS_wake_cause;

RTC_DATA_ATTR uint8_t WIFI_retry = 0;
RTC_DATA_ATTR uint8_t GPS_retry = 0;

struct {
  uint32_t iTOW;
  int32_t lon, lat, height, hMSL;
  uint32_t hAcc, vAcc;
} NAV_POSLLH;

struct {
  uint32_t iTOW;
  uint8_t gpsFix;
  uint8_t flags, fixStat, flags2;
  uint32_t ttff, msss;
} NAV_STATUS;

struct {
  uint32_t iTOW;
  int32_t fTOW;
  int16_t week;
  uint8_t gpsFix, flags;
  int32_t ecefX, ecefY, ecefZ;
  uint32_t pAcc;
  int32_t ecefVX, ecefVY, ecefVZ;
  uint32_t sAcc;
  uint16_t pDOP;
  uint8_t resv1, numSV;
  uint32_t resv2;
} NAV_SOL;

struct {
  uint32_t iTOW, tAcc;
  int32_t nano;
  uint16_t year;
  uint8_t month, day, hour, min, sec, valid;
} NAV_TIMEUTC;

const PROGMEM uint8_t ubx_header[] = {0xB5, 0x62};
const PROGMEM uint8_t cfg_ubx_msg[] = {
  0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x02, 0x01, 0x0E, 0x47, // NAV-POSLLH enabled
  0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x03, 0x01, 0x0F, 0x49, // NAV-STATUS enabled
  0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x21, 0x01, 0x2D, 0x85, // NAV-TIMEUTC enabled
  0xB5, 0x62, 0x06, 0x01, 0x03, 0x00, 0x01, 0x06, 0x01, 0x12, 0x4F  // NAV-SOL enabled
};
const PROGMEM uint8_t cfg_rate[] = {
  0xB5, 0x62, 0x06, 0x08, 0x06, 0x00, 0x32, 0x00, 0x01, 0x00, 0x01, 0x00, 0x48, 0xE6 // 50ms rate
};
const PROGMEM uint8_t cfg_clear[] = {
  0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x27, 0x9A
};
const PROGMEM uint8_t cfg_save[] = {
  0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x27, 0xAA
};
const PROGMEM uint8_t cfg_load[] = {
  0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x27, 0xBA
};
const PROGMEM uint8_t cfg_prt[] = {
  0xB5, 0x62, 0x06, 0x00, 0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD0, 0x08, 0x00, 0x00, 0x00, 0x84, 0x03, 0x00, 0xFF, 0xFF, 0xFD, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x74, 0x78
};
const PROGMEM uint8_t cfg_rxm[] = {
  0xB5, 0x62, 0x06, 0x11, 0x02, 0x00, 0x08, 0x01, 0x22, 0x92
};
const PROGMEM uint8_t cfg_nav5[] = {
  0xB5, 0x62, 0x06, 0x24, 0x24, 0x00, 0x05, 0x00, 0x03, 0x03, 0x50, 0x46, 0x00, 0x00, 0x40, 0x54, 0x89, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x81
};
const PROGMEM uint8_t cfg_pm2[] = {
  0xB5, 0x62,
  0x06, 0x3B,
  0x2C, 0x00,
  0x01, 0x00, 0x00, 0x00,
  0x00, 0x14, 0x01, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x05, 0x00,
  0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x88, 0xB3
};
